
class Maze::Formatter::ASCII::Sigma < Maze::Formatter::ASCII
  
  # FIXME: render does not work for masked grids

  def char
    @char ||= Array.new(ypos(grid.rows, true) + 1) do |x|
      Array.new(xpos(grid.columns) + cell_size) do |y|
        clear
      end
    end
  end  

  def render
    grid.each_cell do |cell|
      draw_cell cell
      draw_content cell
      draw_path cell
    end
    
    ansi_clear + char.map{|l| l.join }.join("\n")
  end
  
  def draw_cell cell
    x0, y0 = coord cell
    x1 = x0 + cell_size
    x2 = x0 + cell_size + cell_size * 3
    y1 = y0 + cell_size

    0.upto(cell_size*3-1) do |i|
      # north
      char[y0][x1+i] = n unless cell.linked? cell.north
      # south
      char[y0+cell_size*2][x1+i] = s unless cell.linked? cell.south
    end

    0.upto(cell_size-1) do |i|
      # north east
      char[y0+1+i][x2+i] = ne unless cell.linked? cell.northeast
      # north west
      char[y0+1+i][x0+cell_size-1-i] = nw unless cell.linked? cell.northwest
      # south east
      char[y1+1+i][x2+cell_size-1-i] = se unless cell.linked? cell.southeast
      # south west
      char[y1+1+i][x0+i] = sw unless cell.linked? cell.southwest
    end
  end
  
  def draw_content cell
    x, y = coord cell
    content_of(cell).center(cell_size * 3).chars.each_with_index do |c,i|
      char[y+cell_size][x+cell_size+i] = c.color(content_color_of(cell))
    end
  end

  # TODO: render real path on sigma grids
  
  def draw_path cell
    return unless highlighted_cell? cell
    x0, y0 = coord cell
    char[y0+cell_size][x0+cell_size * 2] = '*'.color(content_color_of cell)
  end

  def coord cell
    [xpos(cell.column), ypos(cell.row, cell.column.odd?)]
  end
  
  def xpos column
    (cell_size * 4) * column
  end
  
  def ypos row, odd=false
    offset = odd ? cell_size : 0
    (cell_size * 2) * row + offset
  end
  
  def n
    '_'
  end
  
  def ne
    '\\'
  end
  
  def se
    '/'
  end
  
  alias_method :s, :n
  alias_method :sw, :ne
  alias_method :nw, :se
end

__END__

.___.....___.....___.....
/...\___/...\___/...\___.
\___/...\___/...\___/...\
/...\___/...\___/...\___/
\___/...\___/...\___/...\
/...\___/...\___/...\___/
\___/...\___/...\___/....
....\___/...\___/........


..______..........______..........______..........
./......\......../......\......../......\.........
/....._..\___|__/.___....\______/........\______..
\......\_/_..|..\/......./......\......../......\.
.\______/..\_|__/\______/........\______/........\
./......\/...|..\/......\......../......\......../
/........\___|__/........\______/........\______/.
\......../......\......../......\......../......\.
.\______/........\______/........\______/........\
./......\......../......\......../......\......../
/........\______/........\______/........\______/.
\......../......\......../......\......../......\.
.\______/........\______/........\______/........\
........\......../......\......../......\......../
.........\______/........\______/........\______/.


..._________..............._________..............._________
../.........\............./.........\............./.........\
./...........\.........../...........\.........../...........\
/.............\_________/.............\_________/.............\_________
\............./.........\............./.........\............./.........\
.\.........../...........\.........../...........\.........../...........\
..\_________/.............\_________/.............\_________/.............\
../.........\............./.........\............./.........\............./
./...........\.........../...........\.........../...........\.........../
/.............\_________/.............\_________/.............\_________/
\............./.........\............./.........\............./.........\
.\.........../...........\.........../...........\.........../...........\
..\_________/.............\_________/.............\_________/.............\
../.........\............./.........\............./.........\............./
./...........\.........../...........\.........../...........\.........../
/.............\_________/.............\_________/.............\_________/
\............./.........\............./.........\............./.........\
.\.........../...........\.........../...........\.........../...........\
..\_________/.............\_________/.............\_________/.............\
............\............./.........\............./.........\............./
.............\.........../...........\.........../...........\.........../
..............\_________/.............\_________/.............\_________/
